import torch
import torchvision.transforms as transforms
from .sicapv2 import SicapV2
from .sicap_mil import SicapMIL
from .skincancer import SKIN
from .nct import NCT
from .lc_lung import LCLUNG

from .utils import *
from .dataloader import get_dataloader_splits_retina, get_dataloader_splits_radio

from medclip.prompts import generate_chexpert_class_prompts, process_class_prompts, generate_rsna_class_prompts, generate_class_prompts


dataset_list = {
                "sicapv2": SicapV2,
                "skincancer": SKIN,
                "nct": NCT,
                "lc_lung": LCLUNG,
                "sicap_mil":SicapMIL, 
                "chexpert":"chexpert_5x200",
                "mimic":"mimic_5x200", 
                "rsna":"rsna_pneumonia_test",
                "fives": "13_FIVES",
                "odir": "08_ODIR200x3",
                "messidor": "02_MESSIDOR"
                }


def get_dataloader(root, dataset_name, batch_size, num_workers, preprocess, seed, model_name):

    if dataset_name == "chexpert" or dataset_name == "mimic" or dataset_name == "rsna" :
        setting = get_experiment_setting(dataset_list[dataset_name])
        loader = get_dataloader_splits_radio(setting["dataframe"], root + setting["base_samples_path"], setting["targets"], batch_size_test = batch_size)

        print(f"The original {dataset_name} dataset is selected, number of images: {len(loader.dataset)}!\ndatadir: {root}")
        classes = setting["classes"]
        print(classes)
        if dataset_name == "rsna":
            templates = generate_rsna_class_prompts(n=10)
        else:
            templates = generate_chexpert_class_prompts(n=10)

    elif dataset_name == "messidor" or dataset_name == "odir" or dataset_name == "fives" :
        setting = get_experiment_setting(dataset_list[dataset_name])
        loader = get_dataloader_splits_retina(setting["dataframe"], root + setting["base_samples_path"], setting["targets"], transforms=preprocess, batch_size = batch_size)

        print(f"The original {dataset_name} dataset is selected, number of images: {len(loader.dataset)}!\ndatadir: {root}")
        if model_name == "CLIP":
            classes = setting["targets"].keys()
        else:
            classes = setting["classes"]
        print(classes)
        
        templates = openai_templates
    else : 

        dataset = dataset_list[dataset_name](root, preprocess)

        # loader = torch.utils.data.DataLoader(dataset.test, batch_size=batch_size, shuffle=True, num_workers=num_workers, pin_memory=True, drop_last=True)
        loader = build_data_loader(data_source=dataset.test, batch_size=batch_size, is_train=False, tfm=preprocess,
                                        shuffle=True)
        print(f"The original {dataset_name} dataset is selected, number of images: {dataset.len}!\ndatadir: {root}")

        classes = dataset.classes
        templates = dataset.template
        print(classes)

    return loader, classes, templates




## RetCLIP templates
openai_templates = [
    lambda c: f"{c}的照片",
    lambda c: f"质量差的{c}的照片",
    lambda c: f"许多{c}的照片",
    lambda c: f"{c}的雕塑",
    lambda c: f"难以看到{c}的照片",
    lambda c: f"{c}的低分辨率照片",
    lambda c: f"{c}的渲染",
    lambda c: f"涂鸦{c}",
    lambda c: f"{c}的糟糕照片",
    lambda c: f"{c}的裁剪照片",
    lambda c: f"{c}的纹身",
    lambda c: f"{c}的刺绣照片",
    lambda c: f"很难看到{c}的照片",
    lambda c: f"{c}的明亮照片",
    lambda c: f"一张干净的{c}的照片",
    lambda c: f"一张包含{c}的照片",
    lambda c: f"{c}的深色照片",
    lambda c: f"{c}的手绘画",
    lambda c: f"我的{c}的照片",
    lambda c: f"不自然的{c}的照片",
    lambda c: f"一张酷的{c}的照片",
    lambda c: f"{c}的特写照片",
    lambda c: f"{c}的黑白照片",
    lambda c: f"一幅{c}的画",
    lambda c: f"一幅{c}的绘画",
    lambda c: f"一张{c}的像素照片",
    lambda c: f"{c}的雕像",
    lambda c: f"一张{c}的明亮照片",
    lambda c: f"{c}的裁剪照片",
    lambda c: f"人造的{c}的照片",
    lambda c: f"一张关于{c}的照片",
    lambda c: f"损坏的{c}的jpeg照片",
    lambda c: f"{c}的模糊照片",
    lambda c: f"{c}的相片",
    lambda c: f"一张{c}的好照片",
    lambda c: f"{c}的渲染照",
    lambda c: f"视频游戏中的{c}",
    lambda c: f"一张{c}的照片",
    lambda c: f"{c}的涂鸦",
    lambda c: f"{c}的近距离照片",
    lambda c: f"{c}的折纸",
    lambda c: f"{c}在视频游戏中",
    lambda c: f"{c}的草图",
    lambda c: f"{c}的涂鸦照",
    lambda c: f"{c}的折纸形状",
    lambda c: f"低分辨率的{c}的照片",
    lambda c: f"玩具{c}",
    lambda c: f"{c}的副本",
    lambda c: f"{c}的干净的照片",
    lambda c: f"一张大{c}的照片",
    lambda c: f"{c}的重现",
    lambda c: f"一张漂亮的{c}的照片",
    lambda c: f"一张奇怪的{c}的照片",
    lambda c: f"模糊的{c}的照片",
    lambda c: f"卡通{c}",
    lambda c: f"{c}的艺术作品",
    lambda c: f"{c}的素描",
    lambda c: f"刺绣{c}",
    lambda c: f"{c}的像素照",
    lambda c: f"{c}的拍照",
    lambda c: f"{c}的损坏的照片",
    lambda c: f"高质量的{c}的照片",
    lambda c: f"毛绒玩具{c}",
    lambda c: f"漂亮的{c}的照片",
    lambda c: f"小{c}的照片",
    lambda c: f"照片是奇怪的{c}",
    lambda c: f"漫画{c}",
    lambda c: f"{c}的艺术照",
    lambda c: f"{c}的图形",
    lambda c: f"大{c}的照片",
    lambda c: f"黑白的{c}的照片",
    lambda c: f"{c}毛绒玩具",
    lambda c: f"一张{c}的深色照片",
    lambda c: f"{c}的摄影图",
    lambda c: f"{c}的涂鸦照",
    lambda c: f"玩具形状的{c}",
    lambda c: f"拍了{c}的照片",
    lambda c: f"酷酷的{c}的照片",
    lambda c: f"照片里的小{c}",
    lambda c: f"{c}的刺青",
    lambda c: f"{c}的可爱的照片",
    lambda c: f"一张{c}可爱的照片",
    lambda c: f"{c}可爱图片",
    lambda c: f"{c}酷炫图片",
    lambda c: f"一张{c}的酷炫的照片",
    lambda c: f"一张{c}的酷炫图片",
    lambda c: f"这是{c}",
    lambda c: f"{c}的好看照片",
    lambda c: f"一张{c}的好看的图片",
    lambda c: f"{c}的好看图片",
    lambda c: f"{c}的照片。",
    lambda c: f"质量差的{c}的照片。",
    lambda c: f"许多{c}的照片。",
    lambda c: f"{c}的雕塑。",
    lambda c: f"难以看到{c}的照片。",
    lambda c: f"{c}的低分辨率照片。",
    lambda c: f"{c}的渲染。",
    lambda c: f"涂鸦{c}。",
    lambda c: f"{c}的糟糕照片。",
    lambda c: f"{c}的裁剪照片。",
    lambda c: f"{c}的纹身。",
    lambda c: f"{c}的刺绣照片。",
    lambda c: f"很难看到{c}的照片。",
    lambda c: f"{c}的明亮照片。",
    lambda c: f"一张干净的{c}的照片。",
    lambda c: f"一张包含{c}的照片。",
    lambda c: f"{c}的深色照片。",
    lambda c: f"{c}的手绘画。",
    lambda c: f"我的{c}的照片。",
    lambda c: f"不自然的{c}的照片。",
    lambda c: f"一张酷的{c}的照片。",
    lambda c: f"{c}的特写照片。",
    lambda c: f"{c}的黑白照片。",
    lambda c: f"一幅{c}的画。",
    lambda c: f"一幅{c}的绘画。",
    lambda c: f"一张{c}的像素照片。",
    lambda c: f"{c}的雕像。",
    lambda c: f"一张{c}的明亮照片。",
    lambda c: f"{c}的裁剪照片。",
    lambda c: f"人造的{c}的照片。",
    lambda c: f"一张关于{c}的照片。",
    lambda c: f"损坏的{c}的jpeg照片。",
    lambda c: f"{c}的模糊照片。",
    lambda c: f"{c}的相片。",
    lambda c: f"一张{c}的好照片。",
    lambda c: f"{c}的渲染照。",
    lambda c: f"视频游戏中的{c}。",
    lambda c: f"一张{c}的照片。",
    lambda c: f"{c}的涂鸦。",
    lambda c: f"{c}的近距离照片。",
    lambda c: f"{c}的折纸。",
    lambda c: f"{c}在视频游戏中。",
    lambda c: f"{c}的草图。",
    lambda c: f"{c}的涂鸦照。",
    lambda c: f"{c}的折纸形状。",
    lambda c: f"低分辨率的{c}的照片。",
    lambda c: f"玩具{c}。",
    lambda c: f"{c}的副本。",
    lambda c: f"{c}的干净的照片。",
    lambda c: f"一张大{c}的照片。",
    lambda c: f"{c}的重现。",
    lambda c: f"一张漂亮的{c}的照片。",
    lambda c: f"一张奇怪的{c}的照片。",
    lambda c: f"模糊的{c}的照片。",
    lambda c: f"卡通{c}。",
    lambda c: f"{c}的艺术作品。",
    lambda c: f"{c}的素描。",
    lambda c: f"刺绣{c}。",
    lambda c: f"{c}的像素照。",
    lambda c: f"{c}的拍照。",
    lambda c: f"{c}的损坏的照片。",
    lambda c: f"高质量的{c}的照片。",
    lambda c: f"毛绒玩具{c}。",
    lambda c: f"漂亮的{c}的照片。",
    lambda c: f"小{c}的照片。",
    lambda c: f"照片是奇怪的{c}。",
    lambda c: f"漫画{c}。",
    lambda c: f"{c}的艺术照。",
    lambda c: f"{c}的图形。",
    lambda c: f"大{c}的照片。",
    lambda c: f"黑白的{c}的照片。",
    lambda c: f"{c}毛绒玩具。",
    lambda c: f"一张{c}的深色照片。",
    lambda c: f"{c}的摄影图。",
    lambda c: f"{c}的涂鸦照。",
    lambda c: f"玩具形状的{c}。",
    lambda c: f"拍了{c}的照片。",
    lambda c: f"酷酷的{c}的照片。",
    lambda c: f"照片里的小{c}。",
    lambda c: f"{c}的刺青。",
    lambda c: f"{c}的可爱的照片。",
    lambda c: f"一张{c}可爱的照片。",
    lambda c: f"{c}可爱图片。",
    lambda c: f"{c}酷炫图片。",
    lambda c: f"一张{c}的酷炫的照片。",
    lambda c: f"一张{c}的酷炫图片。",
    lambda c: f"这是{c}。",
    lambda c: f"{c}的好看照片。",
    lambda c: f"一张{c}的好看的图片。",
    lambda c: f"{c}的好看图片。",
    lambda c: f"一种叫{c}的花的照片",
    lambda c: f"一种叫{c}的食物的照片",
    lambda c: f"{c}的卫星照片"
]

## RetCLIP templates
"""
openai_templates = [
    "{}的照片",
    "质量差的{}的照片",
    "许多{}的照片",
    "{}的雕塑",
    "难以看到{}的照片",
    "{}的低分辨率照片",
    "{}的渲染",
    "涂鸦{}",
    "{}的糟糕照片",
    "{}的裁剪照片",
    "{}的纹身",
    "{}的刺绣照片",
    "很难看到{}的照片",
    "{}的明亮照片",
    "一张干净的{}的照片",
    "一张包含{}的照片",
    "{}的深色照片",
    "{}的手绘画",
    "我的{}的照片",
    "不自然的{}的照片",
    "一张酷的{}的照片",
    "{}的特写照片",
    "{}的黑白照片",
    "一幅{}的画",
    "一幅{}的绘画",
    "一张{}的像素照片",
    "{}的雕像",
    "一张{}的明亮照片",
    "{}的裁剪照片",
    "人造的{}的照片",
    "一张关于{}的照片",
    "损坏的{}的jpeg照片",
    "{}的模糊照片",
    "{}的相片",
    "一张{}的好照片",
    "{}的渲染照",
    "视频游戏中的{}",
    "一张{}的照片",
    "{}的涂鸦",
    "{}的近距离照片",
    "{}的折纸",
    "{}在视频游戏中",
    "{}的草图",
    "{}的涂鸦照",
    "{}的折纸形状",
    "低分辨率的{}的照片",
    "玩具{}",
    "{}的副本",
    "{}的干净的照片",
    "一张大{}的照片",
    "{}的重现",
    "一张漂亮的{}的照片",
    "一张奇怪的{}的照片",
    "模糊的{}的照片",
    "卡通{}",
    "{}的艺术作品",
    "{}的素描",
    "刺绣{}",
    "{}的像素照",
    "{}的拍照",
    "{}的损坏的照片",
    "高质量的{}的照片",
    "毛绒玩具{}",
    "漂亮的{}的照片",
    "小{}的照片",
    "照片是奇怪的{}",
    "漫画{}",
    "{}的艺术照",
    "{}的图形",
    "大{}的照片",
    "黑白的{}的照片",
    "{}毛绒玩具",
    "一张{}的深色照片",
    "{}的摄影图",
    "{}的涂鸦照",
    "玩具形状的{}",
    "拍了{}的照片",
    "酷酷的{}的照片",
    "照片里的小{}",
    "{}的刺青",
    "{}的可爱的照片",
    "一张{}可爱的照片",
    "{}可爱图片",
    "{}酷炫图片",
    "一张{}的酷炫的照片",
    "一张{}的酷炫图片",
    "这是{}",
    "{}的好看照片",
    "一张{}的好看的图片",
    "{}的好看图片",
    "{}的照片。",
    "质量差的{}的照片。",
    "许多{}的照片。",
    "{}的雕塑。",
    "难以看到{}的照片。",
    "{}的低分辨率照片。",
    "{}的渲染。",
    "涂鸦{}。",
    "{}的糟糕照片。",
    "{}的裁剪照片。",
    "{}的纹身。",
    "{}的刺绣照片。",
    "很难看到{}的照片。",
    "{}的明亮照片。",
    "一张干净的{}的照片。",
    "一张包含{}的照片。",
    "{}的深色照片。",
    "{}的手绘画。",
    "我的{}的照片。",
    "不自然的{}的照片。",
    "一张酷的{}的照片。",
    "{}的特写照片。",
    "{}的黑白照片。",
    "一幅{}的画。",
    "一幅{}的绘画。",
    "一张{}的像素照片。",
    "{}的雕像。",
    "一张{}的明亮照片。",
    "{}的裁剪照片。",
    "人造的{}的照片。",
    "一张关于{}的照片。",
    "损坏的{}的jpeg照片。",
    "{}的模糊照片。",
    "{}的相片。",
    "一张{}的好照片。",
    "{}的渲染照。",
    "视频游戏中的{}。",
    "一张{}的照片。",
    "{}的涂鸦。",
    "{}的近距离照片。",
    "{}的折纸。",
    "{}在视频游戏中。",
    "{}的草图。",
    "{}的涂鸦照。",
    "{}的折纸形状。",
    "低分辨率的{}的照片。",
    "玩具{}。",
    "{}的副本。",
    "{}的干净的照片。",
    "一张大{}的照片。",
    "{}的重现。",
    "一张漂亮的{}的照片。",
    "一张奇怪的{}的照片。",
    "模糊的{}的照片。",
    "卡通{}。",
    "{}的艺术作品。",
    "{}的素描。",
    "刺绣{}。",
    "{}的像素照。",
    "{}的拍照。",
    "{}的损坏的照片。",
    "高质量的{}的照片。",
    "毛绒玩具{}。",
    "漂亮的{}的照片。",
    "小{}的照片。",
    "照片是奇怪的{}。",
    "漫画{}。",
    "{}的艺术照。",
    "{}的图形。",
    "大{}的照片。",
    "黑白的{}的照片。",
    "{}毛绒玩具。",
    "一张{}的深色照片。",
    "{}的摄影图。",
    "{}的涂鸦照。",
    "玩具形状的{}。",
    "拍了{}的照片。",
    "酷酷的{}的照片。",
    "照片里的小{}。",
    "{}的刺青。",
    "{}的可爱的照片。",
    "一张{}可爱的照片。",
    "{}可爱图片。",
    "{}酷炫图片。",
    "一张{}的酷炫的照片。",
    "一张{}的酷炫图片。",
    "这是{}。",
    "{}的好看照片。",
    "一张{}的好看的图片。",
    "{}的好看图片。",
    "一种叫{}的花的照片",
    "一种叫{}的食物的照片",
    "{}的卫星照片"
]
"""
